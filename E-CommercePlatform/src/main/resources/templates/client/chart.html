<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thống kê bán hàng</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { border: 1px solid #e0e0e0; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; background: white; }
        .summary-box { background: #f8f9fa; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; color: #2c3e50; }
        .chart-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .chart-col { flex: 1; min-width: 400px; }

        .filter-bar { margin-bottom: 20px; display: flex; align-items: center; gap: 15px; background: #fff; }
        .filter-group { display: flex; align-items: center; gap: 5px; }

        select { padding: 8px 12px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; outline: none; }
        select:focus { border-color: #007bff; }

        button { padding: 8px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background 0.2s; }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="margin-bottom: 20px; color: #333;">Dashboard Quản Lý</h1>

    <div class="card filter-bar">
        <div class="filter-group">
            <label for="monthFilter">Tháng:</label>
            <select id="monthFilter">
                <option value="1">Tháng 1</option>
                <option value="2">Tháng 2</option>
                <option value="3">Tháng 3</option>
                <option value="4">Tháng 4</option>
                <option value="5">Tháng 5</option>
                <option value="6">Tháng 6</option>
                <option value="7">Tháng 7</option>
                <option value="8">Tháng 8</option>
                <option value="9">Tháng 9</option>
                <option value="10">Tháng 10</option>
                <option value="11">Tháng 11</option>
                <option value="12">Tháng 12</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="yearFilter">Năm:</label>
            <select id="yearFilter">
            </select>
        </div>

        <button onclick="updateCharts()">Xem thống kê</button>
    </div>

    <div class="card summary-box">
        Tổng số đơn hàng:
        <span id="totalOrdersText" style="color: #dc3545;">--</span>
    </div>

    <div class="chart-row">
        <div class="card chart-col">
            <h3 style="text-align: center; margin-bottom: 15px;">Dòng tiền theo ngày</h3>
            <canvas id="lineChartRevenue"></canvas>
        </div>

        <div class="card chart-col">
            <h3 style="text-align: center; margin-bottom: 15px;">Top Sản phẩm bán chạy</h3>
            <canvas id="barChartTopProducts"></canvas>
        </div>
    </div>
</div>

<script>
    let revenueChart = null;
    let productChart = null;

    function populateYearSelect() {
        const yearSelect = document.getElementById('yearFilter');
        const currentYear = new Date().getFullYear();
        for (let i = currentYear; i >= currentYear - 5; i--) {
            let option = document.createElement('option');
            option.value = i;
            option.text = i;
            yearSelect.appendChild(option);
        }
    }

    async function loadSummary(month, year) {
        try {
            const response = await fetch(`/api/stats/summary?month=${month}&year=${year}`);
            if (!response.ok) throw new Error("Lỗi gọi API Summary");
            const count = await response.json();
            document.getElementById('totalOrdersText').innerText = count;
        } catch (error) {
            console.error(error);
            document.getElementById('totalOrdersText').innerText = "Lỗi";
        }
    }

    async function loadRevenueChart(month, year) {
        try {
            const response = await fetch(`/api/stats/revenue?month=${month}&year=${year}`);
            const data = await response.json();

            const labels = data.map(item => item.label);
            const values = data.map(item => item.value);

            const ctx = document.getElementById('lineChartRevenue').getContext('2d');
            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Doanh thu (VNĐ)',
                        data: values,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        pointBackgroundColor: '#28a745',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        } catch (error) {
            console.error("Lỗi tải biểu đồ doanh thu:", error);
        }
    }

    async function loadTopProductsChart(month, year) {
        try {
            const response = await fetch(`/api/stats/top-products?month=${month}&year=${year}`);
            const data = await response.json();

            const labels = data.map(item => item.label);
            const values = data.map(item => item.value);

            const ctx = document.getElementById('barChartTopProducts').getContext('2d');
            if (productChart) productChart.destroy();

            productChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số lượng bán',
                        data: values,
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        } catch (error) {
            console.error("Lỗi tải biểu đồ top sản phẩm:", error);
        }
    }

    function updateCharts() {
        const month = document.getElementById('monthFilter').value;
        const year = document.getElementById('yearFilter').value;

        if (month && year) {
            loadSummary(month, year);
            loadRevenueChart(month, year);
            loadTopProductsChart(month, year);
        } else {
            alert("Vui lòng chọn đầy đủ tháng và năm!");
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        populateYearSelect();

        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;

        document.getElementById('yearFilter').value = currentYear;
        document.getElementById('monthFilter').value = currentMonth;

        updateCharts();
    });
</script>

</body>
</html>