<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông Tin Đặt Hàng - Laptop Store</title>
    <link rel="stylesheet" th:href="@{/client/products.css}">
    <link rel="stylesheet" th:href="@{/client/icons.css}">
    <link rel="stylesheet" th:href="@{/client/checkout.css}">
</head>

<body>
    <!-- Header -->
    <div th:replace="~{client/fragments/header :: header}"></div>

    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <div class="container">
            <a href="/">Trang chủ</a>
            <span>/</span>
            <a href="/cart">Giỏ hàng</a>
            <span>/</span>
            <span>Thông tin đặt hàng</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Error Message -->
        <div th:if="${errorMessage}" class="alert alert-error">
            <span class="icon icon-md icon-error icon-inline"></span>
            <span th:text="${errorMessage}"></span>
        </div>

        <div class="checkout-content">
            <!-- Customer Information Form -->
            <div class="checkout-form-section">
                <div class="section-header">
                    <div class="step-number">1</div>
                    <h2>Thông Tin Khách Hàng</h2>
                </div>
                
                <div class="form-group">
                    <label>Họ và tên</label>
                    <input type="text" th:value="${session.user?.fullName}" readonly class="form-control readonly">
                </div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" th:value="${session.user?.email}" readonly class="form-control readonly">
                </div>

                <div class="section-header" style="margin-top: 30px;">
                    <div class="step-number">2</div>
                    <h2>Địa Chỉ Giao Hàng</h2>
                </div>

                <form id="checkoutForm" th:action="@{/cart/checkout/proceed}" method="post">
                    <div class="form-group">
                        <label for="houseNumber">Số nhà, tên đường <span class="required">*</span></label>
                        <input type="text" id="houseNumber" name="houseNumber" class="form-control"
                            placeholder="Nhập số nhà, tên đường" required>
                    </div>

                    <div class="form-group">
                        <label for="ward">Phường/Xã <span class="required">*</span></label>
                        <input type="text" id="ward" name="ward" class="form-control"
                            placeholder="Nhập phường/xã" required>
                    </div>

                    <div class="form-group">
                        <label for="district">Quận/Huyện <span class="required">*</span></label>
                        <input type="text" id="district" name="district" class="form-control"
                            placeholder="Nhập quận/huyện" required>
                    </div>

                    <div class="form-group">
                        <label for="province">Tỉnh/Thành phố <span class="required">*</span></label>
                        <input type="text" id="province" name="province" class="form-control"
                            placeholder="Nhập tỉnh/thành phố" required>
                    </div>

                    <!-- Hidden field to combine full address -->
                    <input type="hidden" id="address" name="address">

                    <div class="form-group">
                        <label for="phone">Số điện thoại <span class="required">*</span></label>
                        <input type="tel" id="phone" name="phone" class="form-control" 
                            placeholder="Nhập số điện thoại liên hệ" required>
                    </div>

                    <div class="form-group">
                        <label for="note">Ghi chú đơn hàng</label>
                        <textarea id="note" name="note" class="form-control" rows="2" 
                            placeholder="Ghi chú thêm về đơn hàng (tùy chọn)"></textarea>
                    </div>

                    <button type="submit" class="btn btn-checkout" id="proceedBtn">
                        <span class="icon icon-md icon-arrow-right icon-inline"></span>
                        <span id="btnText">Tiến Hành Thanh Toán MoMo</span>
                    </button>
                </form>
            </div>

            <!-- Order Summary -->
            <div class="order-summary">
                <h2>Tóm Tắt Đơn Hàng</h2>
                
                <div class="order-items">
                    <div th:each="item : ${cartItems}" class="order-item">
                        <div class="item-image">
                            <img th:if="${item.product.url != null && !item.product.url.isEmpty()}"
                                th:src="${item.product.url}" th:alt="${item.product.name}">
                            <div th:if="${item.product.url == null || item.product.url.isEmpty()}" class="no-image">
                                <span class="icon icon-lg icon-no-image icon-centered"></span>
                            </div>
                        </div>
                        <div class="item-info">
                            <h4 th:text="${item.product.name}">Product Name</h4>
                            <p class="item-quantity">Số lượng: <span th:text="${item.quantity}">1</span></p>
                        </div>
                        <div class="item-price" 
                            th:text="${#numbers.formatDecimal(item.product.price * item.quantity, 0, 'COMMA', 0, 'POINT')} + ' đ'">
                            0 đ
                        </div>
                    </div>
                </div>

                <div class="summary-divider"></div>

                <div class="summary-row">
                    <span>Tạm tính:</span>
                    <span class="amount" th:text="${#numbers.formatDecimal(cartTotal, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</span>
                </div>

                <div class="summary-row">
                    <span>Phí vận chuyển:</span>
                    <span class="amount shipping-fee">Miễn phí</span>
                </div>

                <div class="summary-divider"></div>

                <div class="summary-row total">
                    <span>Tổng cộng:</span>
                    <span class="amount total-amount" th:text="${#numbers.formatDecimal(cartTotal, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</span>
                </div>

                <div class="payment-method">
                    <h3>Phương thức thanh toán</h3>
                    <div class="payment-options">
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="MOMO" form="checkoutForm" checked>
                            <div class="payment-content">
                                <img src="https://developers.momo.vn/v3/vi/assets/images/icon-52bd5808cecdb1970e1aeec3c31a3ee1.png" alt="MoMo" class="payment-logo">
                                <span>Ví MoMo</span>
                            </div>
                        </label>
                        <label class="payment-option">
                            <input type="radio" name="paymentMethod" value="CASH" form="checkoutForm">
                            <div class="payment-content">
                                <svg class="payment-logo-svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                    <line x1="1" y1="10" x2="23" y2="10"></line>
                                </svg>
                                <span>Tiền mặt</span>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="checkout-benefits">
                    <div class="benefit">
                        <span class="icon icon-sm icon-check-green"></span>
                        <span>Miễn phí vận chuyển</span>
                    </div>
                    <div class="benefit">
                        <span class="icon icon-sm icon-check-green"></span>
                        <span>Bảo hành chính hãng</span>
                    </div>
                    <div class="benefit">
                        <span class="icon icon-sm icon-check-green"></span>
                        <span>Đổi trả trong 7 ngày</span>
                    </div>
                </div>

                <a href="/cart" class="btn btn-back">
                    <span class="icon icon-md icon-back-arrow icon-inline"></span>
                    Quay lại giỏ hàng
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div th:replace="~{client/fragments/footer :: footer}"></div>

    <script>
        // Handle payment method selection
        const paymentRadios = document.querySelectorAll('input[name="paymentMethod"]');
        const btnText = document.getElementById('btnText');

        paymentRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Update button text based on selected payment method
                if (this.value === 'MOMO') {
                    btnText.textContent = 'Tiến Hành Thanh Toán MoMo';
                } else if (this.value === 'CASH') {
                    btnText.textContent = 'Đặt Hàng (Thanh Toán Khi Nhận)';
                }

                // Update selected style
                document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
                this.closest('.payment-option').classList.add('selected');
            });

            // Set initial selected state
            if (radio.checked) {
                radio.closest('.payment-option').classList.add('selected');
            }
        });

        // Auto-combine address fields when form is submitted
        document.getElementById('checkoutForm').addEventListener('submit', function() {
            const houseNumber = document.getElementById('houseNumber').value.trim();
            const ward = document.getElementById('ward').value.trim();
            const district = document.getElementById('district').value.trim();
            const province = document.getElementById('province').value.trim();

            // Combine all fields into full address
            document.getElementById('address').value = [houseNumber, ward, district, province].filter(Boolean).join(', ');
        });
    </script>
</body>

</html>
